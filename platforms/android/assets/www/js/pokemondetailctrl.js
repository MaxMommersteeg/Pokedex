angular.module("starter").controller("PokemonDetailCtrl",["$scope","$state","$stateParams","$http","$timeout","$window","$ionicPopup","positionPreferenceKey","mapPreferenceKey","mypokemonsPreferenceKey","baseUrlGetPokemon","defaultUpdateDistanceTimerDelay","defaultUpdatePokemonPositionTimerDelay","defaultUpdateCheckGpsTimerDelay",function(t,o,e,n,a,s,r,c,m,u,p,l,d,h){function k(t,o,e){var n=function(t,o){var e=Math.random(),n=Math.random();if(o&&e>n){var a=n;n=e,e=a}return[n*t*Math.cos(2*Math.PI*e/n),n*t*Math.sin(2*Math.PI*e/n)]},a=n(e,!0),i=6378137,s=a[0],r=a[1],c=s/i,m=r/(i*Math.cos(Math.PI*(t/180)));return{latitude:t+c*(180/Math.PI),longitude:o+m*(180/Math.PI)}}function g(t,o,e,n){var a=6371e3,i=f(e-t),s=f(n-o),r=Math.sin(i/2)*Math.sin(i/2)+Math.cos(f(t))*Math.cos(f(e))*Math.sin(s/2)*Math.sin(s/2),c=2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r)),m=a*c;return Number(m)}function f(t){return t*(Math.PI/180)}function P(t,o){t.$$phase||t.$root.$$phase?o():t.$apply(o)}t.pokemon={},t.userposition={},t.watchId={},t.map={},t.distanceToPokemon=0,t.showNavigation=!1,t.pokemonAlreadyCatched=!1,t.catchButtonEnabled=!1,t.gpsMessageShownToUser=!1,t.mypokemons=[];var T=null,y=null,w=null;t.$on("$ionicView.enter",function(){t.gpsMessageShownToUser=!1;var o=JSON.parse(window.localStorage.getItem(m));null!=o&&(t.map=o);var n=JSON.parse(window.localStorage.getItem(u));null!=n&&(t.mypokemons=n),P(t,function(){t.pokemonAlreadyCatched=t.alreadyCatched(e.name)}),t.getPokemon(e.name),t.pokemonAlreadyCatched?t.showNavigation=!1:(t.startLocationWatch(),t.startUpdateCheckGpsTimer(),t.startUpdatePokemonPositionTimer(),t.startUpdateDistanceTimer(),t.showNavigation=!0)}),t.$on("$ionicView.beforeLeave",function(){t.stopUpdateDistanceTimer(),t.stopUpdatePokemonPositionTimer(),t.stopUpdateCheckGpsTimer(),navigator.geolocation.clearWatch(t.watchId)}),t.updateDistanceTimer=function(){null!=t.userposition&&null!=t.pokemon.position&&P(t,function(){t.distanceToPokemon=Math.round(g(t.userposition.latitude,t.userposition.longitude,t.pokemon.position.latitude,t.pokemon.position.longitude))}),t.catchButtonEnabled=t.distanceToPokemon<=t.map.catchradius?!0:!1,T=a(t.updateDistanceTimer,l)},t.startUpdateDistanceTimer=function(){T=a(t.updateDistanceTimer,l)},t.stopUpdateDistanceTimer=function(){a.cancel(T)},t.updatePokemonPositionTimer=function(){null==t.pokemon||null==t.userposition||null!=t.pokemon.position&&!isNaN(t.distanceToPokemon)||P(t,function(){t.pokemon.position=k(t.userposition.latitude,t.userposition.longitude,t.map.maximumradius)}),y=a(t.updatePokemonPositionTimer,d)},t.startUpdatePokemonPositionTimer=function(){y=a(t.updatePokemonPositionTimer,d)},t.stopUpdatePokemonPositionTimer=function(){a.cancel(y)},t.updateCheckGpsTimer=function(){try{cordova.plugins.diagnostic.isLocationEnabled(function(o){P(t,function(){t.showNavigation=o}),sn||t.gpsMessageShownToUser||(r.alert({title:"Enable GPS",template:"Real trainers always enable their GPS while hunting"}),t.gpsMessageShownToUser=!0)},function(o){P(t,function(){t.showNavigation=!1})})}catch(o){P(t,function(){t.showNavigation=!1})}w=a(t.updateCheckGpsTimer,h)},t.startUpdateCheckGpsTimer=function(){w=a(t.updateCheckGpsTimer,h)},t.stopUpdateCheckGpsTimer=function(){a.cancel(w)},t.getPokemon=function(o){if(o&&!angular.equals({},o)){var e=p+String(o);n.get(e).then(function(o){t.pokemon=o.data},function(t){})}},t.startLocationWatch=function(){function o(o){P(t,function(){t.userposition={latitude:o.coords.latitude,longitude:o.coords.longitude}})}function e(){}t.watchId=navigator.geolocation.watchPosition(o,e,{timeout:5e3,enableHighAccuracy:!0})},t.navigateToPokemon=function(){try{launchnavigator.navigate([t.pokemon.position.latitude,t.pokemon.position.longitude])}catch(o){r.alert({title:"Navigation",template:"Failed to start navigation"})}},t.alreadyCatched=function(o){if(t.mypokemons=JSON.parse(window.localStorage.getItem(u)),null==t.mypokemons)return!1;for(i=0;i<t.mypokemons.length;i++)if(t.mypokemons[i].name==o)return!0;return!1},t.catchPokemon=function(){return t.alreadyCatched(t.pokemon.name)?void r.alert({title:"Catch",template:"You already own a"+t.pokemon.name+" don't be greedy!"}):(null==t.mypokemons&&(t.mypokemons=[]),t.mypokemons.push({name:t.pokemon.name,catchdate:(new Date).toLocaleString()}),window.localStorage.setItem(u,JSON.stringify(t.mypokemons)),t.showCatchButton=!1,r.alert({title:"Catch",template:"You catched a "+t.pokemon.name+"!"}),void(s.location.href="#/tab/my-pokemons"))}}]);